<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos - Refresquer√≠a EL PORTON</title>
  
  <style>
    /* Variables de color adicionales */
    :root {
      --estado-pendiente: #ff9800;
      --estado-proceso: #2196f3;
      --estado-entregado: #4caf50;
      --estado-cancelado: #f44336;
      --fondo-pendiente: #fff3e0;
      --fondo-proceso: #e3f2fd;
      --fondo-entregado: #e8f5e8;
      --fondo-cancelado: #ffebee;
      --borde-pendiente: #ffb74d;
      --borde-proceso: #64b5f6;
      --borde-entregado: #81c784;
      --borde-cancelado: #ef5350;
      --texto-oscuro: #2c3e50;
      --texto-medio: #546e7a;
      --texto-claro: #78909c;
    }

    .dark {
      --estado-pendiente: #ffb74d;
      --estado-proceso: #64b5f6;
      --estado-entregado: #81c784;
      --estado-cancelado: #e57373;
      --fondo-pendiente: #332900;
      --fondo-proceso: #001a33;
      --fondo-entregado: #003300;
      --fondo-cancelado: #330000;
      --borde-pendiente: #ff9800;
      --borde-proceso: #2196f3;
      --borde-entregado: #4caf50;
      --borde-cancelado: #f44336;
      --texto-oscuro: #eceff1;
      --texto-medio: #b0bec5;
      --texto-claro: #78909c;
    }

    /* Estilos espec√≠ficos para la p√°gina de pedidos */
    .pedidos-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: var(--light);
      min-height: 100vh;
    }

    .pedidos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: var(--radius);
      color: white;
      box-shadow: var(--shadow);
    }

    .pedidos-header h1 {
      margin: 0;
      font-size: 2em;
      font-weight: 700;
    }

    .volver-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .volver-link:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    /* Estad√≠sticas */
    .estadisticas {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .estadistica-card {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .estadistica-numero {
      font-size: 2.5em;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .estadistica-texto {
      color: var(--texto-medio);
      font-weight: 600;
    }

    /* Filtros mejorados */
    .filtros-container {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 25px;
    }

    .filtros {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filtro-btn {
      background: var(--gray-light);
      border: 2px solid var(--border);
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      color: var(--texto-medio);
    }

    .filtro-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .filtro-btn[data-filtro="pendientes"]:not(.active):hover {
      border-color: var(--estado-pendiente);
      color: var(--estado-pendiente);
    }

    .filtro-btn[data-filtro="proceso"]:not(.active):hover {
      border-color: var(--estado-proceso);
      color: var(--estado-proceso);
    }

    .filtro-btn[data-filtro="entregados"]:not(.active):hover {
      border-color: var(--estado-entregado);
      color: var(--estado-entregado);
    }

    .filtro-btn[data-filtro="cancelados"]:not(.active):hover {
      border-color: var(--estado-cancelado);
      color: var(--estado-cancelado);
    }

    /* Grid de pedidos */
    .pedidos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
      gap: 20px;
    }

    /* Tarjetas de pedido con colores diferenciados */
    .pedido-card {
      background: var(--light);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      border-left: 6px solid var(--primary);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .pedido-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary);
    }

    .pedido-card.pendiente {
      border-left-color: var(--estado-pendiente);
      background: var(--fondo-pendiente);
    }

    .pedido-card.pendiente::before {
      background: var(--estado-pendiente);
    }

    .pedido-card.proceso {
      border-left-color: var(--estado-proceso);
      background: var(--fondo-proceso);
    }

    .pedido-card.proceso::before {
      background: var(--estado-proceso);
    }

    .pedido-card.entregado {
      border-left-color: var(--estado-entregado);
      background: var(--fondo-entregado);
    }

    .pedido-card.entregado::before {
      background: var(--estado-entregado);
    }

    .pedido-card.cancelado {
      border-left-color: var(--estado-cancelado);
      background: var(--fondo-cancelado);
    }

    .pedido-card.cancelado::before {
      background: var(--estado-cancelado);
    }

    .pedido-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    /* Header del pedido */
    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(0,0,0,0.1);
    }

    .pedido-cliente {
      flex: 1;
    }

    .pedido-nombre {
      font-size: 1.4em;
      font-weight: 700;
      color: var(--texto-oscuro);
      margin-bottom: 8px;
    }

    .pedido-correo {
      color: var(--texto-medio);
      font-size: 1em;
    }

    .pedido-correo a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }

    .pedido-correo a:hover {
      text-decoration: underline;
    }

    .pedido-info {
      text-align: right;
    }

    .pedido-fecha {
      background: rgba(0,0,0,0.1);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      color: var(--texto-oscuro);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .pedido-estado {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .estado-pendiente {
      background: var(--estado-pendiente);
      color: white;
    }

    .estado-proceso {
      background: var(--estado-proceso);
      color: white;
    }

    .estado-entregado {
      background: var(--estado-entregado);
      color: white;
    }

    .estado-cancelado {
      background: var(--estado-cancelado);
      color: white;
    }

    /* Productos */
    .pedido-productos {
      margin: 20px 0;
      padding: 0;
      list-style: none;
    }

    .producto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      transition: var(--transition);
    }

    .producto-item:hover {
      background: rgba(255,255,255,0.5);
      margin: 0 -10px;
      padding: 12px 10px;
      border-radius: 8px;
    }

    .producto-item:last-child {
      border-bottom: none;
    }

    .producto-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .producto-cantidad {
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85em;
      font-weight: bold;
    }

    .producto-nombre {
      font-weight: 600;
      color: var(--texto-oscuro);
    }

    .producto-precio {
      color: var(--texto-medio);
      font-weight: 600;
    }

    /* Footer del pedido */
    .pedido-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid rgba(0,0,0,0.1);
    }

    .pedido-total {
      font-size: 1.3em;
      font-weight: 700;
      color: var(--primary);
    }

    .pedido-acciones {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-proceso {
      background: var(--estado-proceso);
      color: white;
    }

    .btn-proceso:hover:not(:disabled) {
      background: #1976d2;
      transform: translateY(-2px);
    }

    .btn-entregado {
      background: var(--estado-entregado);
      color: white;
    }

    .btn-entregado:hover:not(:disabled) {
      background: #388e3c;
      transform: translateY(-2px);
    }

    .btn-entregado:disabled {
      background: #a5d6a7;
      cursor: not-allowed;
      transform: none;
    }

    .btn-cancelar {
      background: var(--estado-cancelado);
      color: white;
    }

    .btn-cancelar:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .btn-eliminar {
      background: #78909c;
      color: white;
    }

    .btn-eliminar:hover {
      background: #546e7a;
      transform: translateY(-2px);
    }

    /* Estados de carga y vac√≠o */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--texto-medio);
      font-size: 1.2em;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
      40% { color: var(--texto-medio); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
      60% { text-shadow: .25em 0 0 var(--texto-medio), .5em 0 0 rgba(0,0,0,0); }
      80%, 100% { text-shadow: .25em 0 0 var(--texto-medio), .5em 0 0 var(--texto-medio); }
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--texto-medio);
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5em;
      margin-bottom: 10px;
      color: var(--texto-oscuro);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .pedidos-grid {
        grid-template-columns: 1fr;
      }
      
      .pedidos-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .pedido-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .pedido-info {
        text-align: left;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .pedido-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .pedido-acciones {
        width: 100%;
        flex-wrap: wrap;
      }
      
      .btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .pedidos-container {
        padding: 15px;
      }
      
      .pedido-card {
        padding: 20px;
      }
      
      .filtros {
        justify-content: center;
      }
      
      .estadisticas {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="pedidos-container">
    <div class="pedidos-header">
      <h1>üì¶ Panel de Pedidos</h1>
      <a href="index.html" class="volver-link">
        ‚Üê Volver a la Tienda
      </a>
    </div>

    <!-- Estad√≠sticas -->
    <div class="estadisticas">
      <div class="estadistica-card">
        <div class="estadistica-numero" id="total-pedidos">0</div>
        <div class="estadistica-texto">Total Pedidos</div>
      </div>
      <div class="estadistica-card">
        <div class="estadistica-numero" id="pedidos-pendientes">0</div>
        <div class="estadistica-texto">Pendientes</div>
      </div>
      <div class="estadistica-card">
        <div class="estadistica-numero" id="pedidos-proceso">0</div>
        <div class="estadistica-texto">En Proceso</div>
      </div>
      <div class="estadistica-card">
        <div class="estadistica-numero" id="pedidos-entregados">0</div>
        <div class="estadistica-texto">Entregados</div>
      </div>
      <div class="estadistica-card">
        <div class="estadistica-numero" id="pedidos-cancelados">0</div>
        <div class="estadistica-texto">Cancelados</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filtros-container">
      <h3 style="margin: 0 0 15px 0; color: var(--texto-oscuro);">Filtrar por Estado:</h3>
      <div class="filtros">
        <button class="filtro-btn active" data-filtro="todos">Todos los Pedidos</button>
        <button class="filtro-btn" data-filtro="pendientes">üü° Pendientes</button>
        <button class="filtro-btn" data-filtro="proceso">üîµ En Proceso</button>
        <button class="filtro-btn" data-filtro="entregados">üü¢ Entregados</button>
        <button class="filtro-btn" data-filtro="cancelados">üî¥ Cancelados</button>
      </div>
    </div>

    <!-- Lista de pedidos -->
    <div id="pedidos-container">
      <div class="loading">Cargando pedidos</div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAK2ex1uACVSPo_fxlgN_iDBAWlsBvV4RM",
      authDomain: "refresqueriaporton.firebaseapp.com",
      projectId: "refresqueriaporton",
      storageBucket: "refresqueriaporton.firebasestorage.app",
      messagingSenderId: "608366778564",
      appId: "1:608366778564:web:39cf58eb7802c1e0189191",
      measurementId: "G-LW73YBZVPF"
    };

    if(!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let todosLosPedidos = [];
    let filtroActual = 'todos';

    function formatFecha(valor) {
      if(!valor) return '';
      if(valor.toDate && typeof valor.toDate === 'function') {
        return valor.toDate().toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      try {
        const d = new Date(valor);
        if(!isNaN(d)) return d.toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch(e){}
      return String(valor);
    }

    function actualizarEstadisticas() {
      const total = todosLosPedidos.length;
      const pendientes = todosLosPedidos.filter(p => p.estado === 'pendiente').length;
      const proceso = todosLosPedidos.filter(p => p.estado === 'proceso').length;
      const entregados = todosLosPedidos.filter(p => p.estado === 'entregado').length;
      const cancelados = todosLosPedidos.filter(p => p.estado === 'cancelado').length;

      document.getElementById('total-pedidos').textContent = total;
      document.getElementById('pedidos-pendientes').textContent = pendientes;
      document.getElementById('pedidos-proceso').textContent = proceso;
      document.getElementById('pedidos-entregados').textContent = entregados;
      document.getElementById('pedidos-cancelados').textContent = cancelados;
    }

    function aplicarFiltro() {
      let pedidosFiltrados;
      
      if (filtroActual === 'todos') {
        pedidosFiltrados = todosLosPedidos;
      } else {
        pedidosFiltrados = todosLosPedidos.filter(pedido => pedido.estado === filtroActual);
      }
      
      renderPedidos(pedidosFiltrados);
      actualizarEstadisticas();
    }

    function getEstadoClass(estado) {
      const estados = {
        'pendiente': 'pendiente',
        'proceso': 'proceso', 
        'entregado': 'entregado',
        'cancelado': 'cancelado'
      };
      return estados[estado] || 'pendiente';
    }

    function getEstadoText(estado) {
      const textos = {
        'pendiente': 'Pendiente',
        'proceso': 'En Proceso',
        'entregado': 'Entregado',
        'cancelado': 'Cancelado'
      };
      return textos[estado] || 'Pendiente';
    }

    function renderPedidos(pedidos) {
      const cont = document.getElementById('pedidos-container');
      
      if (pedidos.length === 0) {
        cont.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì¶</div>
            <h3>No hay pedidos ${filtroActual !== 'todos' ? getEstadoText(filtroActual) : ''}</h3>
            <p>${filtroActual === 'todos' ? 'Cuando los clientes realicen pedidos, aparecer√°n aqu√≠.' : 
                `No hay pedidos en estado "${getEstadoText(filtroActual)}" en este momento.`}</p>
          </div>
        `;
        return;
      }

      cont.innerHTML = '<div class="pedidos-grid"></div>';
      const grid = cont.querySelector('.pedidos-grid');

      pedidos.forEach(pedido => {
        const estadoClass = getEstadoClass(pedido.estado);
        const estadoText = getEstadoText(pedido.estado);
        
        const div = document.createElement('div');
        div.className = `pedido-card ${estadoClass}`;

        const fechaTexto = formatFecha(pedido.fecha);

        div.innerHTML = `
          <div class="pedido-header">
            <div class="pedido-cliente">
              <div class="pedido-nombre">üë§ ${pedido.nombre || 'Cliente'}</div>
              <div class="pedido-correo">
                üìß <a href="mailto:${pedido.correo}">${pedido.correo}</a>
              </div>
            </div>
            <div class="pedido-info">
              <div class="pedido-fecha">üìÖ ${fechaTexto}</div>
              <div class="pedido-estado estado-${estadoClass}">${estadoText}</div>
            </div>
          </div>
          
          <ul class="pedido-productos">
            ${(pedido.productos || []).map(prod => `
              <li class="producto-item">
                <div class="producto-info">
                  <span class="producto-cantidad">${prod.cantidad || prod.qty || 1}</span>
                  <span class="producto-nombre">${prod.name}</span>
                </div>
                <span class="producto-precio">${prod.price}</span>
              </li>
            `).join('')}
          </ul>
          
          <div class="pedido-footer">
            <div class="pedido-total">üí∞ Total: $${pedido.total}</div>
            <div class="pedido-acciones">
              ${pedido.estado === 'pendiente' ? `
                <button class="btn btn-proceso" data-id="${pedido.id}">
                  ‚ö° En Proceso
                </button>
              ` : ''}
              ${pedido.estado === 'proceso' ? `
                <button class="btn btn-entregado" data-id="${pedido.id}">
                  ‚úÖ Entregado
                </button>
              ` : ''}
              ${pedido.estado !== 'cancelado' && pedido.estado !== 'entregado' ? `
                <button class="btn btn-cancelar" data-id="${pedido.id}">
                  ‚ùå Cancelar
                </button>
              ` : ''}
              <button class="btn btn-eliminar" data-id="${pedido.id}">
                üóëÔ∏è Eliminar
              </button>
            </div>
          </div>
        `;

        // Botones de acci√≥n
        const setupBoton = (selector, nuevoEstado, confirmMsg) => {
          const boton = div.querySelector(selector);
          if (boton) {
            boton.addEventListener('click', () => {
              if(confirm(confirmMsg)) {
                // Actualizar estado en Firebase
                db.collection('pedidos').doc(pedido.id).update({
                  estado: nuevoEstado,
                  fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                  // Actualizar estado localmente
                  pedido.estado = nuevoEstado;
                  aplicarFiltro();
                  
                  if (nuevoEstado === 'entregado') {
                    // Notificaci√≥n por email
                    const cuerpo = encodeURIComponent(`Hola ${pedido.nombre},

Tu pedido ha sido marcado como ENTREGADO.

üì¶ Resumen del pedido:
${ (pedido.productos || []).map(prod => `‚Ä¢ ${prod.cantidad || prod.qty || 1} x ${prod.name} (${prod.price})`).join('\n') }

üí∞ Total: $${pedido.total}

¬°Gracias por confiar en Refresquer√≠a EL PORTON!

Atentamente,
El equipo de EL PORTON`);
                    window.open(`mailto:${pedido.correo}?subject=¬°Tu pedido ha sido entregado!&body=${cuerpo}`);
                  }
                })
                .catch(err => {
                  console.error('Error actualizando estado:', err);
                  alert('Error al actualizar el estado del pedido');
                });
              }
            });
          }
        };

        setupBoton('.btn-proceso', 'proceso', `¬øPoner el pedido de ${pedido.nombre} en proceso?`);
        setupBoton('.btn-entregado', 'entregado', `¬øMarcar el pedido de ${pedido.nombre} como entregado?`);
        setupBoton('.btn-cancelar', 'cancelado', `¬øCancelar el pedido de ${pedido.nombre}?`);

        // Eliminar pedido
        const btnEliminar = div.querySelector('.btn-eliminar');
        btnEliminar.addEventListener('click', () => {
          if(confirm(`¬øEliminar permanentemente el pedido de ${pedido.nombre}?`)) {
            db.collection('pedidos').doc(pedido.id).delete()
              .then(() => {
                todosLosPedidos = todosLosPedidos.filter(p => p.id !== pedido.id);
                aplicarFiltro();
              })
              .catch(err => {
                console.error('Error eliminando pedido:', err);
                alert('No se pudo eliminar el pedido.');
              });
          }
        });

        grid.appendChild(div);
      });
    }

    function cargarPedidos() {
      const cont = document.getElementById('pedidos-container');
      cont.innerHTML = '<div class="loading">Cargando pedidos</div>';

      db.collection("pedidos")
        .orderBy("fecha", "desc")
        .onSnapshot(snapshot => {
          todosLosPedidos = [];
          
          if (snapshot.empty) {
            cont.innerHTML = `
              <div class="empty-state">
                <div class="icon">üì¶</div>
                <h3>No hay pedidos guardados</h3>
                <p>Cuando los clientes realicen pedidos desde la tienda, aparecer√°n aqu√≠.</p>
              </div>
            `;
            return;
          }

          snapshot.forEach(doc => {
            const data = doc.data();
            todosLosPedidos.push({
              id: doc.id,
              ...data,
              estado: data.estado || 'pendiente' // Estado por defecto
            });
          });

          aplicarFiltro();
        }, err => {
          console.error('Error leyendo pedidos:', err);
          cont.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚ö†Ô∏è</div>
              <h3>Error cargando pedidos</h3>
              <p>No se pudieron cargar los pedidos. Verifica tu conexi√≥n e intenta nuevamente.</p>
            </div>
          `;
        });
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      cargarPedidos();
      
      // Configurar filtros
      document.querySelectorAll('.filtro-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          filtroActual = btn.dataset.filtro;
          aplicarFiltro();
        });
      });
    });
  </script>
</body>
</html>